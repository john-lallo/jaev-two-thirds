<!DOCTYPE HTML>
<html>
<head>
	<title>jaev-2/3</title>
	<style>
		html, body{
			background-color: #111;
			margin: 0;
			border: 0;
		}

		#world {
			margin: 24px;
			position: relative;

			border: 1px dashed #aaa;

			width: 720px;
			height: 720px;

			overflow: hidden;
		}

		/*
		.P {
			position: absolute;

			width: 4px; height: 4px;

			border: 1px solid #aaa;
			border-radius: 100%;

  			box-shadow: 0 0 0 4px #222;
		}
		*/

		.obj-quad {
			position: absolute;

			width: 20px; height: 20px;
			border: 1px solid #aaa;

			/*box-shadow: 0 0 0 3px #222;*/
		}

		.solid { background-color: #aaa; }
	</style>

	<script src = "https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
	<script src = "numeric.js"></script>
	<script language = "javascript">

		/* global */
		var dt = 0.02;

		var g = [0, 0];//-9.81];

		/* rigid body */
		var object = function(i, M, I, q, v, th, ww){

			this.i = i;

			this.M = M;
			this.invM = 1/M;

			this.I = I;
			this.invI = 1/I;
			

			this.q = q;
			this.qprev = numeric['-'](q, numeric['*'](v, dt));

			this.th = th;
			this.thprev = th - ww*dt;

			this.elem = null;
		}
		object.prototype.sync = function(){
			$("#" + this.i).css({
				"-webkit-transform" : "translate("
				+ this.q[0] + "px, "
				+ (-this.q[1]) + "px) "
				+ "rotate(" + (-this.th) + "rad)"
			});
		}

		/* rigid body: rectangle */
		function quad(i, rho, w, h, q, v, th, ww){
			var M = rho * w * h;
			var I = rho * (h*h + w*w) / 12;

			object.call(this, i, M, I, q, v, th, ww);
			this.w = w;
			this.h = h;
		}
		quad.prototype = Object.create(object.prototype);
		quad.prototype.constructor = quad;
		quad.prototype.render = function(){
			var elem_str =
			'<div id = "' + this.i + '" ' +
			'class = "obj-quad" style = "width: ' + this.w + 'px; height: ' + this.h + 'px; ' +
			'bottom: ' + (-this.h/2) + 'px; left: ' + (-this.w/2) + 'px" ' +
			'></div>';
		
			$("#world").append(elem_str);
			this.sync();
		}

		
		/* constraint */
		function constraint(A, B){
			this.A = A; this.B = B;
		}

		constraint.prototype.prepare = function(){ return; }

		constraint.prototype.jacobian = function(){ return [[0, 0, 0, 0, 0, 0]]; }

		constraint.prototype.C = function(){ return [[0]]; }
		constraint.prototype.solve = function(){


			//if (Math.abs(this.C()[0][0]) < 0.01){ console.log('skip:' + this.C()[0][0]); return; }

			var J = this.jacobian();
			var JT = numeric['transpose'](J);

			var W = [
					[ this.A.invM, 0, 0, 0, 0, 0 ],
					[ 0, this.A.invM, 0, 0, 0, 0 ],
					[ 0, 0, this.A.invI, 0, 0, 0 ],
					[ 0, 0, 0, this.B.invM, 0, 0 ],
					[ 0, 0, 0, 0, this.B.invM, 0 ],
					[ 0, 0, 0, 0, 0, this.B.invI ]
					];

			var invJWJT = numeric['inv'](numeric['dot'](J, numeric['dot'](W, JT)));

			var lambda = numeric['dot'](
						invJWJT,
						numeric['*'](-1, this.C())
					);

			var dq = numeric['dot'](numeric['dot'](W, JT), lambda);
			//console.log(dq);

			//update q
			this.A.q = numeric['+'](this.A.q, [dq[0][0], dq[1][0]]);
			this.A.th += dq[2][0];
			this.B.q = numeric['+'](this.B.q, [dq[3][0], dq[4][0]]);
			this.B.th += dq[5][0];
		}


		/* constraint: angle constraint */
		function angle_constraint(A, B){
			constraint.call(this, A, B);
		}
		angle_constraint.prototype = Object.create(constraint.prototype);
		angle_constraint.prototype.constructor = angle_constraint;
		
		angle_constraint.prototype.C = function(){ return [[(this.A.th - this.B.th)]]; }
		angle_constraint.prototype.error = function(){ return this.A.th - this.B.th; }
		angle_constraint.prototype.jacobian = function(){
			return [[0, 0, 1, 0, 0, -1]];
		}


		/* constraint: revolute constraint */
		
		function rev_constraint(A, B, P){
			constraint.call(this, A, B);

			this.rA = numeric['-'](P, A.q);

			this.rA = [ Math.cos(this.A.th)*this.rA[0] + Math.sin(this.A.th)*this.rA[1],
						- Math.sin(this.A.th)*this.rA[0] + Math.cos(this.A.th)*this.rA[1] ];

			this.rB = numeric['-'](P, B.q);
			this.rB = [ Math.cos(this.B.th)*this.rB[0] + Math.sin(this.B.th)*this.rB[1],
						- Math.sin(this.B.th)*this.rB[0] + Math.cos(this.B.th)*this.rB[1] ];

			this.RA = this.rA; this.RB = this.rB;
		}

		rev_constraint.prototype = Object.create(constraint.prototype);
		rev_constraint.prototype.constructor = rev_constraint;

		rev_constraint.prototype.prepare = function(){

			this.RA = [ Math.cos(this.A.th)*this.rA[0] - Math.sin(this.A.th)*this.rA[1],
						Math.sin(this.A.th)*this.rA[0] + Math.cos(this.A.th)*this.rA[1]];

			this.RB = [ Math.cos(this.B.th)*this.rB[0] - Math.sin(this.B.th)*this.rB[1],
						Math.sin(this.B.th)*this.rB[0] + Math.cos(this.B.th)*this.rB[1]];
		}

		rev_constraint.prototype.C = function(){
			var e = numeric['-'](
			numeric['+'](this.A.q, this.RA),
			numeric['+'](this.B.q, this.RB)
			);

			return [[ (e[0]*e[0] + e[1]*e[1]) ]];
		}
		rev_constraint.prototype.jacobian = function(){

			var D = numeric['-'](
			numeric['+'](this.A.q, this.RA),
			numeric['+'](this.B.q, this.RB)
			)

			var J = [[
				D[0],
				D[0],
				D[0]*(-this.RA[0]*Math.sin(this.A.th)-this.RA[1]*Math.cos(this.A.th))
				+D[1]*(this.RA[1]*Math.cos(this.A.th)-this.RA[0]*Math.sin(this.A.th)),
				D[1],
				D[1],
				D[0]*(-this.RB[0]*Math.sin(this.B.th)-this.RB[1]*Math.cos(this.B.th))
				+D[1]*(this.RB[1]*Math.cos(this.B.th)-this.RB[0]*Math.sin(this.B.th))
				]];

			//console.log(J);

			return J;
		}
		



		var B = [];			// list of bodies
		var blabel = 0;

		var C = [];
		var clabel = 0;		// list of constraints


		//integrate positions
		function integrate(){
			B.forEach(function(b){

				//translation
				var a = g;
				var qnext = numeric['+'](
							numeric['-'](numeric['*'](2, b.q), b.qprev),
							numeric['*'](a, dt*dt)
							)
				b.qprev = b.q; b.q = qnext;

				//rotation
				var alpha = 0;
				var thnext = b.th*2 - b.thprev + alpha*dt*dt;
				b.thprev = b.th; b.th = thnext;

			});
		}


		//solve constraints
		function constrain(){
			C.forEach(function(c){
				c.prepare();
				c.solve();
			});
		}


		function timestep(){
			integrate();
			constrain();

			B.forEach(function(b){ b.sync() })
		}

		function init(){

			B[blabel] = new quad(blabel, 1, 20, 20, [260, 200], [0, 10], 0, 0);
			B[blabel].render(); ++blabel;

			B[blabel] = new quad(blabel, 1, 20, 20, [260, 260], [0, 0], 0, 0);
			B[blabel].render(); ++blabel;

			B[blabel] = new quad(blabel, 1, 20, 20, [200, 260], [0, 0], 0, 0);
			B[blabel].render(); ++blabel;

			B[blabel] = new quad(blabel, 1, 20, 20, [200, 200], [0, 0], 0, 0);
			B[blabel].render(); ++blabel;

			C[clabel] = new rev_constraint(B[0], B[1], [260, 260]); ++clabel;




		}

		$(document).ready(function(){
			init();

			//window.setInterval(timestep, 160 * dt);
		});

		




	</script>
</head>

<body>
	<div id = "world">
	</div>


</body>

</html>
